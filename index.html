<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Rivava Finance Tracker</title>

<!-- PWA & Mobile App Manifest -->
<link rel="manifest" href="./manifest.json">
<meta name="theme-color" content="#000000">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Rivava Finance">
<meta name="application-name" content="Rivava Finance">

<!-- App Icons (uses your folder: icons_folder) -->
<link rel="icon" type="image/png" sizes="32x32" href="./icons_folder/icon-32x32.png">
<link rel="apple-touch-icon" href="./icons_folder/icon-180x180.png">

<!-- Fonts -->
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet" />

<!-- Load Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

<style>
  :root{
    --bg-dark:#000;
    --card-dark:#0d0d0d;
    --accent:#00ffc3;
    --accent-glow: rgba(0, 255, 195, 0.3);
    --text:#fff;
    --muted:#888;
    --danger: #ff5252;
  }
  *{box-sizing:border-box}
  html {
    -webkit-tap-highlight-color: transparent;
  }
  body{
    margin:0;
    font-family:'Poppins',sans-serif;
    background:var(--bg-dark);
    color:var(--text);
    -webkit-font-smoothing:antialiased;
    min-height:100vh;
    overflow-x: hidden;
    overscroll-behavior-y: contain;
  }

  /* Header */
  header{
    display:flex;
    align-items:center;
    justify-content:space-between;
    padding: 12px 16px;
    background:var(--card-dark);
    border-bottom:1px solid #1a1a1a;
    position:sticky;
    top:0;
    z-index:100;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
  }
  .header-right { display: flex; align-items: center; gap: 12px; }
  .brand { display:flex; align-items:center; gap:12px; }
  .logo-img { width:40px; height:40px; border-radius:8px; object-fit:cover; }
  .username { font-size:1.25rem; font-weight:700; background:linear-gradient(90deg,var(--accent),#fff); -webkit-background-clip:text; -webkit-text-fill-color:transparent; }
  
  /* Feedback Button */
  .feedback-btn {
      background: #1a1a1a;
      border: 1px solid #333;
      color: var(--muted);
      width: 44px; height: 44px;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease-in-out;
  }
  .feedback-btn:hover {
      border-color: var(--accent);
      color: var(--accent);
      transform: scale(1.1) rotate(10deg);
  }
  .feedback-btn svg { width: 22px; height: 22px; stroke: currentColor; stroke-width: 2; }

  /* Install App Button */
  #installBtn {
      display: none;
      background: var(--accent);
      color: #000;
      border: none;
      padding: 8px 16px;
      font-weight: 600;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s ease;
  }
  #installBtn:hover { transform: translateY(-2px); box-shadow: 0 4px 12px var(--accent-glow); }

  /* Profile Dropdown & Avatar */
  .profile-container { position: relative; display: inline-block; }
  .profile-avatar, .avatar-initials { width: 44px; height: 44px; border-radius: 50%; cursor: pointer; border: 2px solid #333; transition: all 0.2s ease; }
  .profile-avatar:hover, .avatar-initials:hover { border-color: var(--accent); box-shadow: 0 0 10px var(--accent-glow); }
  .avatar-initials {
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.2rem;
      font-weight: 700;
      color: #000;
  }
  .profile-dropdown { display: none; position: absolute; top: 60px; right: 0; background-color: #111; min-width: 220px; box-shadow: 0 8px 25px rgba(0,0,0,0.5); border-radius: 12px; z-index: 101; border: 1px solid #222; overflow: hidden; animation: fadeIn 0.2s ease-out; }
  @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
  .profile-dropdown.show { display: block; }
  .dropdown-header { padding: 16px; border-bottom: 1px solid #222; }
  .dropdown-name { font-weight: 600; font-size: 1rem; margin: 0; }
  .dropdown-email { color: var(--muted); font-size: 0.85rem; margin: 4px 0 0; }
  .dropdown-item { display: block; width: 100%; padding: 12px 16px; border: none; background: none; color: var(--text); text-align: left; cursor: pointer; font-size: 0.9rem; font-weight: 600; transition: background-color 0.2s ease; }
  .dropdown-item:hover { background-color: #222; }
  .dropdown-item.danger { color: var(--danger); }
  .dropdown-item.danger:hover { background-color: rgba(255, 82, 82, 0.1); }

  /* Main Content Area */
  main {
      max-width: 920px;
      margin: 28px auto;
      padding: 0 16px;
  }
  
  /* Button Loading Animation */
  button.primary .spinner { display: none; border: 2px solid rgba(0, 0, 0, 0.3); border-radius: 50%; border-top-color: #000; width: 20px; height: 20px; animation: spin 1s ease-in-out infinite; }
  button.primary.is-loading .spinner { display: block; }
  button.primary.is-loading .btn-text { display: none; }
  button.primary.is-loading { cursor: not-allowed; display: flex; justify-content: center; align-items: center; }
  @keyframes spin { to { transform: rotate(360deg); } }

  /* Modals */
  .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: radial-gradient(circle at center, rgba(0,0,0,0.6), rgba(0,0,0,0.8)); backdrop-filter: blur(8px); display: flex; align-items: center; justify-content: center; z-index: 10000; opacity: 0; pointer-events: none; transition: opacity 0.3s ease; }
  .modal-overlay.show { opacity: 1; pointer-events: auto; }
  .modal-content { background: var(--card-dark); padding: 30px; border-radius: 16px; border: 1px solid #222; box-shadow: 0 15px 40px rgba(0, 0, 0, 0.6); text-align: center; width: 90%; max-width: 420px; transform: scale(0.9); transition: transform 0.3s cubic-bezier(0.18, 0.89, 0.32, 1.28); }
  .modal-overlay.show .modal-content { transform: scale(1); }
  .modal-logo { width: 70px; height: 70px; margin: 0 auto 15px; border-radius: 12px; animation: logo-pop 0.5s 0.2s ease-out backwards; }
  @keyframes logo-pop { 0% { transform: scale(0.5) rotate(-15deg); opacity: 0; } 100% { transform: scale(1) rotate(0deg); opacity: 1; } }
  .modal-content h2 { margin: 0 0 10px; font-size: 1.8rem; color: var(--accent); font-weight: 700; }
  .modal-content p { margin: 0 0 25px; color: var(--muted); font-size: 1rem; }
  .modal-content button { background: var(--accent); border: none; padding: 12px 30px; border-radius: 8px; color: #000; font-weight: 700; cursor: pointer; font-size: 1rem; transition: all 0.2s ease; }
  .modal-content button:hover { transform: translateY(-2px); box-shadow: 0 4px 12px var(--accent-glow); }
  
  /* Redesigned Feedback Modal */
  #feedback-category-selection { display: flex; flex-direction: column; gap: 12px; margin-top: 10px; }
  .feedback-category-card { background: #111; border: 1px solid #222; border-radius: 10px; padding: 16px; text-align: left; cursor: pointer; transition: all 0.2s ease; }
  .feedback-category-card:hover { border-color: var(--accent); background: #1a1a1a; transform: translateY(-2px); }
  .feedback-category-card h3 { margin: 0 0 4px; color: var(--text); font-size: 1.1rem; }
  .feedback-category-card p { margin: 0; color: var(--muted); font-size: 0.9rem; }
  #feedback-text-input { display: none; }
  .modal-content textarea { width: 100%; height: 120px; background: #050505; border: 1px solid #222; color: var(--text); border-radius: 8px; padding: 12px; font-family: 'Poppins', sans-serif; font-size: 1rem; margin-bottom: 16px; resize: vertical; }
  .modal-content textarea:focus { outline: none; border-color: var(--accent); box-shadow: 0 0 0 2px rgba(0,255,195,0.2); }
  .modal-actions { display: flex; gap: 10px; justify-content: center; }
  .modal-actions button { flex: 1; }
  .modal-actions button.secondary { background: #222; color: var(--text); }
  .modal-actions button.secondary:hover { background: #333; box-shadow: none; }

  /* Info Blocks & Main UI */
  .info-blocks{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:15px;margin-bottom:18px;}
  .info-block{background:var(--card-dark);padding:14px;border-radius:12px;text-align:center;border:1px solid #1a1a1a;transition: all 0.3s ease;}
  .info-block:hover { transform: translateY(-3px); box-shadow: 0 6px 15px rgba(0, 255, 195, 0.1); border-color: #222; }
  .info-block .value{display:block;margin-top:8px;font-size:1.6rem;color:var(--accent);font-weight:600;}
  .tabs{display:flex;gap:10px;margin-bottom:16px;}
  .tab{flex:1;background:var(--card-dark);padding:12px;border-radius:10px;text-align:center;cursor:pointer;border:1px solid #1a1a1a;transition:all 0.2s ease;}
  .tab:hover{background:#111;}
  .tab.active{background:var(--accent);color:#000;font-weight:700;}
  .form-section{display:none; background:var(--card-dark);padding:18px;border-radius:12px;border:1px solid #1a1a1a;}
  .form-section.active{display:block; animation: formFadeIn 0.5s ease;}
  @keyframes formFadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
  label{display:block;margin-bottom:6px;font-weight:600;font-size:0.9rem;}
  input,select{width:100%;padding:12px;border-radius:8px;background:#050505;border:1px solid #222;color:var(--text);margin-bottom:12px;font-size:16px;font-family:'Poppins',sans-serif; transition: border-color 0.2s ease, box-shadow 0.2s ease;}
  input:focus,select:focus{outline:none;border-color:var(--accent);box-shadow:0 0 0 2px rgba(0,255,195,0.2);}
  
  button.animated-add {
    background: var(--accent); border: none; padding: 14px 20px; border-radius: 8px; color: #000; font-weight: 700; cursor: pointer; width: 100%; margin-top: 8px; font-size: 1rem; transition: all 0.2s ease; position: relative; overflow: hidden;
  }
  button.animated-add:hover { transform: translateY(-2px); box-shadow: 0 4px 15px var(--accent-glow); }
  button.animated-add:active { transform: translateY(-1px) scale(0.98); box-shadow: 0 2px 8px var(--accent-glow); }
  
  button.primary{background:var(--accent);border:none;padding:14px 20px;border-radius:8px;color:#000;font-weight:700;cursor:pointer;width:100%;margin-top:16px;font-size:1rem;transition: all 0.2s ease;}
  button.primary:hover{transform: translateY(-2px);box-shadow: 0 4px 12px var(--accent-glow);}

  .table-container{overflow-x:auto;margin-top:24px;margin-bottom:16px;border-radius:12px;border: 1px solid #1a1a1a;-webkit-overflow-scrolling: touch;}
  table{width:100%;border-collapse:collapse;min-width:600px;}
  th,td{padding:12px 15px;border-bottom:1px solid #222;text-align:left;white-space: nowrap;}
  th{color:var(--accent);font-weight:700;font-size:0.9rem;background: rgba(255,255,255,0.02);}
  td{font-size:0.9rem;}
  td button{background:var(--danger);color:#fff;border:none;padding:6px 10px;border-radius:6px;cursor:pointer;font-size:0.8rem;transition: all 0.2s ease;min-width: 60px;}
  td button:hover{background:#ff3838;}
  
  /* --- IMPROVED: Table Row Animation --- */
  @keyframes rowFadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
  tr.new-row { animation: rowFadeIn 0.4s ease-out; }

  /* Welcome Overlay */
  #welcomeOverlay{
    position:fixed; top: 24px; left: 50%; transform: translateX(-50%) translateY(-20px); width: auto; max-width: 90%; padding: 16px 24px; border-radius: 12px; background: linear-gradient(135deg, #0d0d0d, #1a1a1a); color: var(--text); display: flex; align-items: center; gap: 16px; box-shadow: 0 12px 30px rgba(0,0,0,0.6); opacity: 0; pointer-events: none; z-index: 9999; transition: opacity .4s ease, transform .4s ease; border: 1px solid #222;
  }
  #welcomeOverlay.show{ opacity:1; transform: translateX(-50%) translateY(0); }
  #welcomeOverlay #welcomeAvatar { width: 52px; height: 52px; border-radius: 50%; object-fit: cover; border: 2px solid var(--accent); }
  #welcomeOverlay .welcome-main-text { font-weight: 700; font-size: 1.1rem; line-height: 1.2; }
  #welcomeOverlay .welcome-sub-text { font-weight: 400; font-size: 0.9rem; color: var(--muted); margin-top: 4px; }
  
  /* Mobile Optimizations */
  @media(max-width:768px){
    main { margin: 16px auto; padding: 0 16px; }
    .info-blocks{ grid-template-columns:1fr 1fr; gap:12px; }
    .tabs{ flex-direction:row; gap:8px; }
    .tab { font-size: 0.9rem; }
    table{min-width:600px;}
  }

  @media(max-width:480px){
    main { padding: 0 12px; }
    .info-blocks{ grid-template-columns:1fr; }
    .tabs{ flex-direction:column; }
    .form-section { padding: 16px; }
    td, th { padding: 10px 12px; font-size: 0.85rem; }
  }
  ::-webkit-scrollbar{width:8px;height:8px} ::-webkit-scrollbar-track{background:#111} ::-webkit-scrollbar-thumb{background:#333;border-radius:4px}
</style>
</head>
<body>

<header>
  <div class="brand">
    <img src="./logo.png" alt="Rivava Logo" class="logo-img">
    <div class="username">RIVAVA</div>
  </div>
  <div class="header-right">
    <button id="installBtn">Install App</button>
    <button id="feedbackBtn" class="feedback-btn" onclick="openFeedbackModal(true)" aria-label="Open Feedback Form">
        <svg viewBox="0 0 24 24" fill="none"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path></svg>
    </button>
    <div id="topUserArea"></div>
  </div>
</header>

<main id="mainContent" style="display: none;">
  <div class="info-blocks">
    <div class="info-block">Time<span class="value" id="liveTime">--:--:-- --</span></div>
    <div class="info-block">Date<span class="value" id="fixedDate">--/--/----</span></div>
    <div class="info-block" style="grid-column: 1 / -1;">Total Expense<span class="value" id="totalExpense">₹0</span></div>
  </div>

  <div class="tabs">
    <div class="tab active" onclick="showTab('earning')">Earning</div>
    <div class="tab" onclick="showTab('expense')">Expense</div>
  </div>

  <div id="earning" class="form-section active">
    <label for="earningCategory">Category</label>
    <select id="earningCategory" onchange="handleEarningCategoryChange()"><option>Salary</option><option>Daily Earning</option><option>Other</option></select>
    <input type="text" id="customEarningCategory" placeholder="Enter custom earning source" style="display:none;" />
    <label for="earningAmount">Amount</label>
    <input type="number" id="earningAmount" placeholder="Enter earning amount" min="0" step="0.01" />
    <button class="animated-add" onclick="addEarning()">Add Earning</button>
  </div>

  <div id="expense" class="form-section">
    <label for="expenseCategory">Category</label>
    <select id="expenseCategory" onchange="handleCategoryChange()"><option>Personal</option><option>Food</option><option>Transport</option><option>Shopping</option><option>Recharge and Bills</option><option>Entertainment</option><option>Other</option></select>
    <input type="text" id="customCategory" placeholder="Enter custom category" style="display:none;" />
    <label for="expenseAmount">Amount</label>
    <input type="number" id="expenseAmount" placeholder="Enter expense amount" min="0" step="0.01" />
    <label for="paymentMethod">Payment Method</label>
    <select id="paymentMethod"><option>UPI</option><option>Cash</option><option>Credit Card</option><option>Bank Transfer</option></select>
    <button class="animated-add" onclick="addExpense()">Add Expense</button>
  </div>

  <div class="table-container">
    <table id="dataTable" aria-label="Transactions table">
      <thead><tr><th>Type</th><th>Amount</th><th>Category</th><th>Payment</th><th>Date</th><th>Time</th><th>Action</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>
  <button id="submitBtn" class="primary" onclick="submitForm()">
      <span class="btn-text">Submit All Transactions</span>
      <div class="spinner"></div>
  </button>
</main>

<!-- New User Modal -->
<div id="newUserModal" class="modal-overlay">
    <div class="modal-content">
        <h2>Welcome to Rivava!</h2>
        <p>Please confirm your details to get started.</p>
        <label for="userNameInput" style="text-align: left; display: block; margin-bottom: 6px;">Full Name</label>
        <input type="text" id="userNameInput" placeholder="Your full name">
        <label for="phoneInput" style="text-align: left; display: block; margin-bottom: 6px;">Phone Number</label>
        <input type="tel" id="phoneInput" placeholder="Your phone number">
        <button onclick="completeRegistration()">Save & Continue</button>
    </div>
</div>


<!-- Modals and Overlays -->
<div id="welcomeOverlay" role="status" aria-live="polite">
    <img id="welcomeAvatar" src="" alt="User Avatar">
    <div class="welcome-content">
        <div id="welcomeText" class="welcome-main-text"></div>
        <div id="welcomeSubText" class="welcome-sub-text"></div>
    </div>
</div>

<div id="successModal" class="modal-overlay">
    <div class="modal-content">
        <img src="./logo.png" alt="Success" class="modal-logo">
        <h2>Success!</h2>
        <p>Your transactions have been saved securely.</p>
        <button onclick="closeModal('successModal')">Done</button>
    </div>
</div>

<div id="feedbackModal" class="modal-overlay">
    <div class="modal-content">
        <div id="feedback-category-selection">
            <h2>Submit Feedback</h2>
            <p>What is your feedback about?</p>
            <div class="feedback-category-card" onclick="selectFeedbackCategory('Bug / Issue')">
                <h3>Report a Bug / Issue</h3>
                <p>Let us know if something isn't working right.</p>
            </div>
            <div class="feedback-category-card" onclick="selectFeedbackCategory('Feature Suggestion')">
                <h3>Suggest a Feature</h3>
                <p>Have a great idea for a new feature?</p>
            </div>
            <div class="feedback-category-card" onclick="selectFeedbackCategory('Other')">
                <h3>Other Comments</h3>
                <p>General thoughts, questions, or praise.</p>
            </div>
        </div>
        <div id="feedback-text-input">
            <h2 id="feedback-title">Your Feedback</h2>
            <textarea id="feedbackText" placeholder="Please provide as much detail as possible..."></textarea>
            <div class="modal-actions">
                <button class="secondary" onclick="openFeedbackModal(true)">Back</button>
                <button class="primary" onclick="submitFeedback()">
                    <span class="btn-text">Send Feedback</span>
                    <div class="spinner"></div>
                </button>
            </div>
        </div>
    </div>
</div>

<script>
let selectedFeedbackCategory = '';
let deferredInstallPrompt = null;
const installButton = document.getElementById('installBtn');

window.addEventListener('beforeinstallprompt', (e) => {
    e.preventDefault();
    deferredInstallPrompt = e;
    installButton.style.display = 'block';
});

installButton.addEventListener('click', async () => {
    if (!deferredInstallPrompt) { return; }
    deferredInstallPrompt.prompt();
    const { outcome } = await deferredInstallPrompt.userChoice;
    deferredInstallPrompt = null;
    installButton.style.display = 'none';
});

window.addEventListener('appinstalled', () => {
    deferredInstallPrompt = null;
    installButton.style.display = 'none';
});

/* ----------------------
  CONFIG & INITIALIZATION
  ---------------------- */
const firebaseConfig = { apiKey: "AIzaSyAEB3DSSIWATjfcbmkO094GsO56paxrDhU", authDomain: "rivava-finance-tracker.firebaseapp.com", projectId: "rivava-finance-tracker", storageBucket: "rivava-finance-tracker.appspot.com", messagingSenderId: "615077199032", appId: "1:615077199032:web:fb2007f8a603fa8abcc84d" };
let db;
try { if (!firebase.apps.length) { firebase.initializeApp(firebaseConfig); } db = firebase.firestore(); } catch (error) { console.error("Firebase Init Error:", error); }

/* ----------------------
  PAGE NAVIGATION
  ---------------------- */
function viewHistory() {
    window.location.href = './history.html';
}

/* ----------------------
  MODAL & UI HELPERS
  ---------------------- */
function showWelcome(name, picture){
    const ov = document.getElementById('welcomeOverlay');
    const subtextEl = ov.querySelector('#welcomeSubText');
    const subtexts = ["Let's make today profitable.", "Your financial journey continues.", "Track every rupee, build your future.", "Smart tracking for a brighter tomorrow."];
    const randomSubtext = subtexts[Math.floor(Math.random() * subtexts.length)];

    ov.querySelector('#welcomeText').textContent = `Welcome back, ${name}!`;
    ov.querySelector('#welcomeAvatar').src = picture || './icons_folder/icon-180x180.png'; // Fallback icon
    subtextEl.textContent = randomSubtext;

    ov.classList.add('show');
    setTimeout(()=> ov.classList.remove('show'), 3500);
}

function openModal(modalId) { document.getElementById(modalId).classList.add('show'); }
function closeModal(modalId) { document.getElementById(modalId).classList.remove('show'); }

document.querySelectorAll('.modal-overlay').forEach(modal => {
    modal.addEventListener('click', (e) => {
        if (e.target === modal && modal.id !== 'newUserModal') {
            closeModal(modal.id);
        }
    });
});

function openFeedbackModal(reset = false) {
    if (reset) {
        document.getElementById('feedback-category-selection').style.display = 'flex';
        document.getElementById('feedback-text-input').style.display = 'none';
        document.getElementById('feedbackText').value = '';
    }
    openModal('feedbackModal');
}

function selectFeedbackCategory(category) {
    selectedFeedbackCategory = category;
    document.getElementById('feedback-title').textContent = `Feedback: ${category}`;
    document.getElementById('feedback-category-selection').style.display = 'none';
    document.getElementById('feedback-text-input').style.display = 'block';
    document.getElementById('feedbackText').focus();
}

async function submitFeedback() {
    const feedbackText = document.getElementById('feedbackText').value.trim();
    if (!feedbackText || !selectedFeedbackCategory) return;
    const user = JSON.parse(localStorage.getItem('rivava_user'));
    if (!user) { return; }

    const payload = { userEmail: user.email, category: selectedFeedbackCategory, feedback: feedbackText, submittedAt: firebase.firestore.FieldValue.serverTimestamp() };
    const feedbackBtn = document.querySelector('#feedbackModal .primary');
    feedbackBtn.classList.add('is-loading');
    feedbackBtn.disabled = true;

    try {
        await db.collection('feedback').add(payload);
        closeModal('feedbackModal');
    } catch (error) { console.error("Feedback Error:", error); } 
    finally { feedbackBtn.classList.remove('is-loading'); feedbackBtn.disabled = false; }
}

/* ----------------------
  AUTH & USER UI
  ---------------------- */
function setSignedInUI(userObj, showWelcomeFlag){
  document.getElementById('mainContent').style.display = 'block';
  document.getElementById('feedbackBtn').style.display = 'flex';
  const topUserArea = document.getElementById('topUserArea');
  topUserArea.innerHTML = ''; 
  const profileContainer = document.createElement('div');
  profileContainer.className = 'profile-container';
  
  let avatarHTML;
  if (userObj.picture) {
      avatarHTML = `<img src="${userObj.picture}" alt="Profile" class="profile-avatar">`;
  } else {
      const initial = userObj.name ? userObj.name.charAt(0).toUpperCase() : '?';
      const colors = ['#00ffc3', '#ff6b6b', '#4d94ff', '#feca57', '#ff9ff3'];
      const color = colors[Math.abs(initial.charCodeAt(0) - 65) % colors.length];
      avatarHTML = `<div class="avatar-initials" style="background-color: ${color};">${initial}</div>`;
  }

  profileContainer.innerHTML = `<div class="profile-avatar-wrapper">${avatarHTML}</div><div id="profileDropdown" class="profile-dropdown">
    <div class="dropdown-header"><div class="dropdown-name">${userObj.name}</div><div class="dropdown-email">${userObj.email}</div></div>
    <button class="dropdown-item" onclick="viewHistory()">View Dashboard</button>
    <button class="dropdown-item danger" onclick="signOut()">Sign out</button>
  </div>`;
  profileContainer.querySelector('.profile-avatar-wrapper').onclick = (e) => { 
      e.stopPropagation();
      document.getElementById('profileDropdown').classList.toggle('show'); 
  };
  topUserArea.appendChild(profileContainer);
  if(showWelcomeFlag) { showWelcome(userObj.name.split(' ')[0], userObj.picture); }
}

function signOut(){ 
    localStorage.removeItem('rivava_user'); 
    window.location.href = './login.html';
}

async function completeRegistration() {
    const user = JSON.parse(localStorage.getItem('rivava_user'));
    const phone = document.getElementById('phoneInput').value.trim();
    const name = document.getElementById('userNameInput').value.trim();

    if (!phone || !name) { alert("Please fill in all fields."); return; }
    user.phone = phone;
    user.name = name;

    try {
        await db.collection('users').doc(user.sub).set({
            name: user.name,
            email: user.email,
            phone: user.phone,
            picture: user.picture || null, // Ensure picture is not undefined
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
        }, { merge: true });

        localStorage.setItem('rivava_user', JSON.stringify(user));
        closeModal('newUserModal');
        setSignedInUI(user, true);
    } catch (error) {
        console.error("Error completing registration:", error);
        alert("Could not complete registration. Please try again.");
    }
}


/* ----------------------
  INITIALIZATION & CORE LOGIC
  ---------------------- */
window.addEventListener('load', async ()=> {
  setFixedDate();
  startLiveTime();
  if ('serviceWorker' in navigator) { navigator.serviceWorker.register('./sw.js').then(reg => console.log('SW registered!', reg.scope)).catch(err => console.log('SW registration failed: ', err)); }
  
  const storedUserStr = localStorage.getItem('rivava_user');
  if(!storedUserStr){ window.location.href = './login.html'; return; } 

  try {
      const user = JSON.parse(storedUserStr);
      const userDoc = await db.collection('users').doc(user.sub).get();

      if (!userDoc.exists || !userDoc.data().phone) {
          document.getElementById('userNameInput').value = user.name;
          openModal('newUserModal');
      } else {
          const dbUser = userDoc.data();
          const updatedUser = { ...user, ...dbUser };
          localStorage.setItem('rivava_user', JSON.stringify(updatedUser));
          setSignedInUI(updatedUser, false);
      }
  } catch(e){ 
      console.error("Auth check failed:", e);
      localStorage.removeItem('rivava_user'); 
      window.location.href = './login.html';
  }
});

window.addEventListener('click', (e) => {
    const pc = document.querySelector('.profile-container');
    if (pc && !pc.contains(e.target)) {
        document.getElementById('profileDropdown')?.classList.remove('show');
    }
});

function showTab(tab) { document.querySelectorAll('.tab').forEach(t => t.classList.remove('active')); document.querySelectorAll('.form-section').forEach(s => s.classList.remove('active')); document.querySelector(`.tab[onclick="showTab('${tab}')"]`).classList.add('active'); document.getElementById(tab).classList.add('active'); }
function setFixedDate() { const d = new Date(); document.getElementById("fixedDate").textContent = `${String(d.getDate()).padStart(2,"0")}/${String(d.getMonth()+1).padStart(2,"0")}/${d.getFullYear()}`; }
function startLiveTime() { const el = document.getElementById("liveTime"); function u() { const n = new Date(); let h=n.getHours(); el.textContent = `${String(h%12||12).padStart(2,"0")}:${String(n.getMinutes()).padStart(2,"0")}:${String(n.getSeconds()).padStart(2,"0")} ${h>=12?'PM':'AM'}`; } u(); setInterval(u, 1000); }
const dataTableBody = document.querySelector("#dataTable tbody");
function updateTotalExpense() { let sum = 0; dataTableBody.querySelectorAll("tr").forEach(row => { if (row.cells[0].textContent === "Expense") { const amt = parseFloat(row.cells[1].textContent); if (!isNaN(amt)) sum += amt; } }); document.getElementById("totalExpense").textContent = `₹${sum.toFixed(2)}`; }
function addRow(type, amount, category, payment, date, time) { const row = document.createElement("tr"); row.className = 'new-row'; row.innerHTML = `<td>${type}</td><td>${parseFloat(amount).toFixed(2)}</td><td>${category}</td><td>${payment}</td><td>${date}</td><td>${time}</td><td><button onclick="deleteRow(this)">Delete</button></td>`; dataTableBody.appendChild(row); setTimeout(()=> row.classList.remove('new-row'), 500); updateTotalExpense(); }
function deleteRow(button) { button.closest("tr").remove(); updateTotalExpense(); }
function handleEarningCategoryChange() { const sel = document.getElementById("earningCategory"), inp = document.getElementById("customEarningCategory"); if (sel.value === "Other") { inp.style.display = "block"; inp.focus(); } else { inp.style.display = "none"; inp.value = ""; } }
function handleCategoryChange() { const sel = document.getElementById("expenseCategory"), inp = document.getElementById("customCategory"); if (sel.value === "Other") { inp.style.display = "block"; inp.focus(); } else { inp.style.display = "none"; inp.value = ""; } }
function addEarning() { const amountInput = document.getElementById("earningAmount"); const amount = amountInput.value.trim(); if (!amount || +amount <= 0) { amountInput.focus(); return; } let category = document.getElementById("earningCategory").value; if (category === "Other") { category = document.getElementById("customEarningCategory").value.trim(); if (!category) { document.getElementById("customEarningCategory").focus(); return; } } addRow("Earning", amount, category, "-", document.getElementById("fixedDate").textContent, document.getElementById("liveTime").textContent); amountInput.value = ""; if (document.getElementById("earningCategory").value === "Other") { document.getElementById("customEarningCategory").value = ""; handleEarningCategoryChange(); document.getElementById("earningCategory").value = "Salary"; } }
function addExpense() { const amountInput = document.getElementById("expenseAmount"); const amount = amountInput.value.trim(); if (!amount || +amount <= 0) { amountInput.focus(); return; } let category = document.getElementById("expenseCategory").value; if (category === "Other") { category = document.getElementById("customCategory").value.trim(); if (!category) { document.getElementById("customCategory").focus(); return; } } addRow("Expense", amount, category, document.getElementById("paymentMethod").value, document.getElementById("fixedDate").textContent, document.getElementById("liveTime").textContent); amountInput.value = ""; if (document.getElementById("expenseCategory").value === "Other") { document.getElementById("customCategory").value = ""; handleCategoryChange(); document.getElementById("expenseCategory").value = "Personal"; } }

// --- ⚡️ FIXED & IMPROVED: Form Submission to Firebase ---
async function submitForm() {
  if (dataTableBody.children.length === 0) return;
  const user = JSON.parse(localStorage.getItem('rivava_user'));
  if (!user || !user.sub) { alert("You must be signed in to submit."); return; }

  const submitBtn = document.getElementById('submitBtn');
  submitBtn.classList.add('is-loading');
  submitBtn.disabled = true;

  const rows = Array.from(dataTableBody.querySelectorAll('tr')).map(r => {
      // Helper function to parse DD/MM/YYYY and HH:MM:SS AM/PM into a valid Date object
      const dateParts = r.cells[4].textContent.split('/'); // [DD, MM, YYYY]
      const timeString = r.cells[5].textContent; // e.g., "02:05:30 PM"
      const [time, modifier] = timeString.split(' ');
      let [hours, minutes, seconds] = time.split(':');
      if (hours === '12') { hours = '00'; }
      if (modifier === 'PM') { hours = parseInt(hours, 10) + 12; }
      // new Date() wants (YYYY, MonthIndex, Day, Hr, Min, Sec)
      const transactionDate = new Date(dateParts[2], dateParts[1] - 1, dateParts[0], hours, minutes, seconds);

      return {
          type: r.cells[0].textContent,
          amount: +r.cells[1].textContent,
          category: r.cells[2].textContent,
          payment: r.cells[3].textContent,
          // Convert the JS Date to a Firestore Timestamp for proper data handling
          transactionDate: firebase.firestore.Timestamp.fromDate(transactionDate),
          submittedAt: firebase.firestore.FieldValue.serverTimestamp()
      };
  });
  
  const batch = db.batch();
  // Saving to the 'submissions' collection as requested
  const submissionsCollection = db.collection('users').doc(user.sub).collection('submissions');
  
  rows.forEach(submission => {
      const newSubmissionRef = submissionsCollection.doc();
      batch.set(newSubmissionRef, submission);
  });

  try {
    await batch.commit();
    openModal('successModal');
    dataTableBody.innerHTML = '';
    updateTotalExpense();
  } catch (error) { 
    console.error("Submit Error:", error); 
    alert("There was an error saving your data. Please check your connection and try again.");
  } 
  finally { 
    submitBtn.classList.remove('is-loading'); 
    submitBtn.disabled = false; 
  }
}
</script>

</body>
</html>
